<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>C++ Debugging Exercise</title>
    <link rel="stylesheet" href="style/app.css" />
    <!-- codemirror -->
    <script src="ext/codemirror-5.45.0/lib/codemirror.js"></script>
    <link rel="stylesheet" href="ext/codemirror-5.45.0/lib/codemirror.css" />
    <script src="ext/codemirror-5.45.0/mode/clike/clike.js"></script>
    <style>.CodeMirror { font-size: 16px; }</style>
  </head>
  <body>
    <header>
      <h1>{{ part.name | escape }} - {{ step.name | escape }}</h1>
    </header>

    <div class="row" id="instructions">
      <h2>Instructions</h2>
      {{ step.instructions | escape }}
    </div>

    {%- if step.kind not in ['Done'] %}
    <div class="row" id="program">
      {%- if run is none %}
      <textarea id="cpp-code">{{ part.program }}</textarea>
      {%- else %}
      <textarea id="cpp-code">{{ run.source }}</textarea>
       {%- endif %}
    </div>
    {%- endif %}

    {%- if step.kind in ['Run', 'Modify'] %}
    <div class="row">
      <form action="{{ step.uid }}/run" method="post" onsubmit="copyCode(this)">
        <textarea style="display:none;" name="code" id="code"></textarea>
        <input class="button" type="submit" value="Compile &amp; Run" />
      </form>
    </div>
    {%- endif %}

    {%- if step.kind in ['Question'] %}
      {%- if student_id not in step.answers %}
    <div class="row">
      <section id="student-input">
      <h1>{{ step.question | escape }}</h1>
      <form action="{{ step.uid }}/answer" method="post">
        <textarea name="answer">Enter your idea here....</textarea>
        <input class="button" type="submit" value="Submit" />
      </form>
     </section>
    </div>

      {%- else %}
    <div class="row">
      <section id="student-input">
      <h1>{{ step.question | escape }}</h1>
      <form action="{{ step.uid }}/answer" method="post">
        <textarea name="answer">{{ step.answers[student_id] }}</textarea>
        <input class="button" type="submit" value="Update" />
      </form>
      </section>

      <section id="student-responses">
      <h1>Other students' responses:</h1>
      {%- for student, text in step.answers.items() %}
        {%- if student_id != student %}
      <div>"{{ text | escape }}"</div>
        {%- endif %}
      {%- endfor %}
      </section>
    </div>
    <div class="row">
      <form action="{{ step.uid }}/next" method="post">
        <input class="button" type="submit" value="Next" />
      </form>
    </div>

      {%- endif %}
    {%- endif %}

    {%- if step.kind in ['Intro'] %}
    <div class="row">
      <form action="{{ step.uid }}/next" method="post">
        <input class="button" type="submit" value="Next" />
      </form>
    </div>
    {%- endif %}

    {%- if step.kind in ['Run', 'Modify'] and run is not none %}
    <div class="row tabs">
      <form>
      <input id="tab3" type="radio" name="tabs" checked="true" onchange="tab(this)"/>
      <label for="tab3">Compiler Output</label>
      <input id="tab4" type="radio" name="tabs" onchange="tab(this)"/>
      <label for="tab4">Program Output</label>
      </form>
      <div id="content3" class="content">
        <div id="compiler-out" class="output">{{ run.compile.stderr | escape }}</div>
      </div>
      <div id="content4" class="content">
        <div id="program-out" class="output">{{ run.run.stdout | escape }}</div>
      </div>
    </div>
    <div class="row">
      <form action="{{ step.uid }}/next" method="post">
        <input class="button" type="submit" value="Next" />
      </form>
    </div>
    {%- endif %}

  <!-- checkout https://codemirror.net/mode/clike/ -->
  <script>
    var myCodeMirror = CodeMirror.fromTextArea(document.getElementById("cpp-code"), {
      mode:  "text/x-c++src",
      lineNumbers: true,
      matchBrackets: true,
    {% if step.kind in ['Modify'] -%}
      readOnly: false,
    {% else -%}
      readOnly: true,
    {%- endif %}
      identUnit: 4
    });
    var mac = CodeMirror.keyMap.default == CodeMirror.keyMap.macDefault;
    CodeMirror.keyMap.default[(mac ? "Cmd" : "Ctrl") + "-Space"] = "autocomplete";

    // tab switch function
    function tab(el) {
      var name = "content" + el.id.slice(-1)
      var row = el.parentElement.parentElement;
      row.childNodes.forEach(function(node){
        if(node.tagName == "DIV") {
          if(node.id == name) { node.style.display = "block"; }
          else { node.style.display = "none"; }
        }
      });
    }
    // hide all tabs
    document.querySelectorAll(".tabs div.content").forEach(function(node) {
      node.style.display = "none";
    });
    // display program output
    tab(document.getElementById("tab4"));

    // copy code before submitting
    function copyCode(form) {
      var ta = form.querySelector('#code').textContent = myCodeMirror.getValue()
    }
  </script>
  </body>
</html>
